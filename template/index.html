<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Portfolio</title>

        <script src="asset/js/jquery-3.3.1.min.js"></script>
        <script src="asset/js/jquery-ui.js"></script>

        <link href="asset/css/jquery-ui.css" rel="stylesheet">
        <link href="asset/css/portfolio.css" rel="stylesheet">

        <!-- From https://jqueryui.com/tabs/ -->
        <!--
                <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <link rel="stylesheet" href="https://jqueryui.com/resources/demos/style.css">
        -->

        <!-- https://mottie.github.io/tablesorter/docs/ -->
        <link href="asset/js/tablesorter-master/dist/css/theme.default.min.css" rel="stylesheet">
        <script src="asset/js/tablesorter-master/dist/js/jquery.tablesorter.min.js"></script>
        <script src="asset/js/tablesorter-master/dist/js/jquery.tablesorter.widgets.min.js"></script>


        <script>
            $(function () {
                $(".tabs").tabs();



                $("#tabs-portfolios").tabs();
                $("#tabs-shares").tabs();
                $(".tablesorter").tablesorter();
            });


            $(document).ready(function () {

                var token = "";


                // Get list of unique share
                var share_symbol = [];
                var share_detail = {};
                $("tr[data-share_symbol]").each(function () {
                    share_detail.symbol = $(this).data('share_symbol');
                    share_symbol.push(share_detail);
                });
                share_symbol = jQuery.unique(share_symbol);


                //console.log(share_symbol);

                $(share_symbol).each(function (index, value) {
                    return true
                    var symbol = value.symbol;
                    //https://www.alphavantage.co/documentation/
                    var url = "https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=" + symbol + "&interval=1min&apikey=YCR6LSYJNTTISX2Y" + token;

                    var jqxhr = $.ajax(url)
                            .done(function (msg) {
                                $(this).price = '';
                                var tmp = msg["Time Series (1min)"];
                                var current_price = null;
                                for (var date in tmp) {
                                    if (null == current_price) {
                                        current_price = tmp[date]["4. close"];
                                    }
                                }


                                $("tr[data-share_symbol='" + symbol + "'] ").each(function (item) {
                                    $(this).find('td.current span').html(current_price);
                                    var buying_price = parseFloat($(this).find('.buying_unit_price span').html());
                                    var quantity = parseInt($(this).find('.quantity span').html());
                                    var dividend = parseFloat($(this).find('.dividend span').html());
                                    var last_fee_fixed = parseFloat($(this).find('.last_fee_fixed span').html());
                                    var last_fee_percent = parseFloat($(this).find('.last_fee_percent span').html());
                                    var return_cash = ((current_price - buying_price) * quantity) + dividend - last_fee_fixed - (last_fee_percent / 100 * quantity * buying_price);
                                    var return_percent = return_cash / (buying_price * quantity) * 100;

                                    $(this).find('.current span').text(current_price);
                                    $(this).find('.return_cash span').text(Math.round((return_cash * 100)) / 100);
                                    $(this).find('.return_percent span').text(Math.round((return_percent * 100)) / 100);
                                    var gain_way = "positive";
                                    if (return_cash < 0) {
                                        gain_way = "negative";
                                    }
                                    $(this).find('.return_cash').attr('data-gain-way', gain_way);

                                });
                                console.log(current_price);

                            })
                            .fail(function (msg) {
                                console.log(msg);
                                alert("error");
                            })
                            .always(function (msg) {
                                //console.log(msg);
                                //alert( "complete");
                            });
                });

//console.log(share_symbol);

                while (1 == 2) {
                    setTimeout(
                            function ()
                            {
                                console.log($.now());
                                // Foreach share
                                // Call api to get last value
                                // Update values
                            }, 5000);
                }

            });

        </script>


    </head>
    <body>

        <div class="tabs">
            <ul>
                <li><a href="#tab-performances">Performances</a></li>
                <li><a href="#tab-historic">Historic</a></li>
            </ul>

            <div id="tab-performances">
                <div class="tabs">
                    <ul>
                        <?php 
                        foreach ($templates['performance']['byPortfolio']['portfolios'] as $performance_portfolio) {
                        ?>
                        <li><a href="#tab-performance-portfolio-<?php echo $performance_portfolio->portfolio->id;?>"><?php echo $performance_portfolio->portfolio->name;?></a></li>
                        <?php 
                        }
                        ?>
                    </ul>

                    <?php 
                    foreach ($templates['performance']['byPortfolio']['portfolios'] as $performance_portfolio) {
                        
                    ?>
                    <div id="tab-performance-portfolio-<?php echo $performance_portfolio->portfolio->id;?>">
                        <div class="tabs">
                            <ul>
                                <li><a href="#tab-performance-portfolio-<?php echo $performance_portfolio->portfolio->id;?>-active">Active</a></li>
                                <li><a href="#tab-performance-portfolio-<?php echo $performance_portfolio->portfolio->id;?>-inactive">Inactive</a></li>
                            </ul>
                            
                            <div id="tab-performance-portfolio-<?php echo $performance_portfolio->portfolio->id;?>-active">
                                <?php
                                $shares = $performance_portfolio->active_shares;
                                include __DIR__.'/portfolio-shares-active.inc.html';
                                ?>
                            </div>
                            <div id="tab-performance-portfolio-<?php echo $performance_portfolio->portfolio->id;?>-inactive">
                                <?php
                                include __DIR__.'/portfolio-shares-inactive.inc.html';
                                ?>
                            </div>
                        </div>
                    </div>
                    <?php 
                    }
                    ?>
                </div>
                        
            </div>
            <div id="tab-historic">
                <table class="tablesorter">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Portfolio</th>
                            <th>Share</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Type</th>
                            <th>Fee Fixed</th>
                            <th>Fee percent</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php 
                        foreach ($templates['historic'] as $transaction) {
                        ?>
                        <tr 
                            data-id_share="<?php echo $transaction->share->id; ?>"
                        >
                            <th><?php echo $transaction->date->format('d/m/Y'); ?></th>
                            <th><?php echo $transaction->portfolio->name; ?></th>
                            <th><?php echo $transaction->share->name; ?></th>
                            <th><?php echo $transaction->quantity; ?></th>
                            <th><?php echo $transaction->unit_price; ?></th>
                            <th><?php echo $transaction->type; ?></th>
                            <th><?php echo $transaction->fee_fixed; ?></th>
                            <th><?php echo $transaction->fee_percent; ?></th>
                        </tr>
                        <?php 
                        }
                        ?>
                    </tbody>
                </table>
            </div>
        </div>
        
        <pre>
            @TODO : Performances -> Portfolio -> Active -> Set Current Unit Price : Search price
            @TODO : Performances -> Portfolio -> Active -> Reload data
            @TODO : Performances -> Portfolio -> Active -> Set total
            @TODO : Performances -> Portfolio -> Set cash value
            @TODO : Performances -> Portfolio -> Set total
            @TODO : Performances -> Portfolio -> Active -> Set a benchmark value
            @TODO : Performances -> Portfolio -> Set cash history value
            @TODO : Performances -> Portfolio -> Not Active -> Set quantity, unit_price mine and all CAC40, history 
            @TODO : Performances -> Portfolio -> Active -> Set quantity, unit_price mine and all CAC40, history 
            @TODO : Performances -> Portfolio -> Set graph with benchmark
            @TODO : Order and align table
        </pre>

        @Monnaie : Etherum / Bitcoin /Ripple
        @Information Ocfx / Coin checkup
        @Plateforme Kirachan / Bitstamp
        <div id="tabs-portfolios">
            <ul>
                <li><a href="#tabs-performance">Performances</a></li>
                <li><a href="#tabs-historic">Historic</a></li>
                <li><a href="#tabs-detail">Detail</a></li>
                <li><a href="#tabs-share">Share</a></li>
            </ul>
            <div id="tabs-performance">
                <!-- Foreach portfolio -->
                <div class="portfolio">
                    <div class="title">
                        Portfolio n°1
                    </div>
                    <div class="shares">
                        <table class="tablesorter">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Code</th>
                                    <th>Buying unit price</th>
                                    <th>Quantity</th>
                                    <th>Dividend</th>
                                    <th>Current</th>
                                    <th>Return (EUR)</th>
                                    <th>Return (%)</th>
                                    <th>Last Fee fixed</th>
                                    <th>Last Fee percent</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Foreach share -->
                                <tr data-share_symbol='DBG.PA'>
                                    <td>Dérichebourg</td>
                                    <td>DBG.PA</td>
                                    <td class='buying_unit_price'><span>1.894</span> €</td>
                                    <td class='quantity'><span>100</span></td>
                                    <td class='dividend'><span>0</span></td>
                                    <td class='current'><span></span> €</td>
                                    <td class='return_cash' data-gain-way=''><span></span> €</td>
                                    <td class='return_percent' data-gain-way=''><span></span> %</td>
                                    <td class='last_fee_fixed'><span>8</span> €</td>
                                    <td class='last_fee_percent'><span>0</span> %</td>
                                </tr>
                                <!-- Foreach /share -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- /Foreach -->
            </div>
            <div id="tabs-historic">
                Historique
            </div>
            <div id="tabs-detail">
                Détails
            </div>
            <div id="tabs-share">
                <div id="shares">
                    <ul>
                        <li><a href="#tabs-share-gle">GLE - Société Générale</a></li>
                        <div id="tabs-share-GLE">
                            Détails de l'action
                        </div>
                    </ul>
                </div>
            </div>
        </div>


    </body>
</html>