<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Portfolio</title>

        <script src="asset/js/jquery-3.3.1.min.js"></script>
        <script src="asset/js/jquery-ui.js"></script>

        <link href="asset/css/jquery-ui.css" rel="stylesheet">
        <link href="asset/css/portfolio.css" rel="stylesheet">

        <!-- From https://jqueryui.com/tabs/ -->
        <!--
                <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <link rel="stylesheet" href="https://jqueryui.com/resources/demos/style.css">
        -->

        <!-- https://mottie.github.io/tablesorter/docs/ -->
        <link href="asset/js/tablesorter-master/dist/css/theme.default.min.css" rel="stylesheet">
        <script src="asset/js/tablesorter-master/dist/js/jquery.tablesorter.min.js"></script>
        <script src="asset/js/tablesorter-master/dist/js/jquery.tablesorter.widgets.min.js"></script>

        <!-- https://github.com/akquinet/jquery-toastmessage-plugin -->
        <script src="asset/js/jquery-toastmessage-plugin/src/main/javascript/jquery.toastmessage.js"></script>
        <link href="asset/js/jquery-toastmessage-plugin/src/main/resources/css/jquery.toastmessage.css" rel="stylesheet">
        

        <script>
            $(function () {
                // Enable tabs
                $(".tabs").tabs();
                $(".tablesorter").tablesorter();
            });
            
            
            /**
             * @author http://www.manasbhardwaj.net/get-unique-values-from-a-javascript-array-using-jquery/
             * @param array index
             * @returns array
             */
            function GetUnique(inputArray)
            {
                    var outputArray = [];
                    for (var i = 0; i < inputArray.length; i++)
                    {
                            if ((jQuery.inArray(inputArray[i], outputArray)) == -1)
                            {
                                    outputArray.push(inputArray[i]);
                            }
                    }
                    return outputArray;
            }
            
            function reloadPortfolioTotal(table) {
                var spend = 0;
                var total_virtual_gain_price = 0;
                var total_virtual_gain_percent = 0;
                var total_gain_price = 0;
                var total_gain_percent = 0;
                table.find('tbody tr').each(function(index, tr){
                    spend += $(tr).find('td[data-buying_unit_price]').data('buying_unit_price') * $(tr).find('td[data-quantity]').data('quantity');
                    total_virtual_gain_price += $(tr).find('td[data-virtual_gain_price]').data('virtual_gain_price');
                    total_gain_price += $(tr).find('td[data-gain_price]').data('gain_price');
                });
                total_virtual_gain_percent = total_virtual_gain_price / spend * 100;
                total_gain_percent = total_gain_price / spend * 100;
                
                var virtual_gain_loose_gain = 'gain';
                    if (total_virtual_gain_percent<0) {
                        virtual_gain_loose_gain='loose';
                }
                var gain_loose_gain = 'gain';
                    if (total_gain_percent<0) {
                        gain_loose_gain='loose';
                }
                table.find('td[data-total_virtual_gain_price]').data('total_virtual_gain_price', Math.round((total_virtual_gain_price * 100) / 100));
                table.find('tfoot span.total_virtual_gain_price').html(total_virtual_gain_price);
                table.find('tfoot td[data-total_virtual_gain_price]').removeClass('gain loose');
                table.find('tfoot td[data-total_virtual_gain_price]').addClass(virtual_gain_loose_gain);
                
                table.find('td[data-total_virtual_gain_percent]').data('total_virtual_gain_percent', Math.round((total_virtual_gain_percent * 100) / 100));
                table.find('tfoot span.total_virtual_gain_percent').html(Math.round((total_virtual_gain_percent * 100) / 100));
                table.find('tfoot td[data-total_virtual_gain_percent]').removeClass('gain loose');
                table.find('tfoot td[data-total_virtual_gain_percent]').addClass(virtual_gain_loose_gain);
                
                table.find('td[data-total_gain_price]').data('total_gain_price', Math.round((total_gain_price * 100) / 100));
                table.find('tfoot span.total_gain_price').html(total_gain_price);
                table.find('tfoot td[data-total_gain_price]').removeClass('gain loose');
                table.find('tfoot td[data-total_gain_price]').addClass(gain_loose_gain);
                
                table.find('td[data-total_gain_percent]').data('total_gain_percent', Math.round((total_gain_percent * 100) / 100));
                table.find('tfoot span.total_gain_percent').html(Math.round((total_gain_percent * 100) / 100));
                table.find('tfoot td[data-total_gain_percent]').removeClass('gain loose');
                table.find('tfoot td[data-total_gain_percent]').addClass(gain_loose_gain);
            }


            $(document).ready(function () {

                var debug = true;
                
                // Get list of unique share to reload
                var share_symbol = [];
                $("tr[data-id_share].active").each(function () {
                    var share = {};
                    share.symbol = $(this).data('id_share');
                    share.open_market = $(this).data('share_openmarket');
                    share.last_price = null;
                    //share_symbol.push($(this).data('id_share'));
                    share_symbol.push(share);
                });
                share_symbol = GetUnique(share_symbol);

                if (debug) {
                    console.log(share_symbol);
                }


                var today = new Date();
                function reloadShare() {
                    var share_count = share_symbol.length;
                    $(share_symbol).each(function (index, share) {
                        
                        if (null == share.last_price || ("24" == share.open_market) || ((0 < today.getDay() && (today.getDay() < 6)))) {
                        
                            if (debug) {
                                console.log('Retrieve Share "'+share.symbol+'". LastPrice : '+share.last_price+', share.open_market : '+share.open_market+', GetDay : '+today.getDay());
                            }

                            var url = "<?php /*echo $templates['user']->webservice[1]->url;*/ ?>".replace("@symbol@", share.symbol);
                            var jqxhr = $.ajax(url)
                                    .done(function (msg) {
                                        $(this).price = '';
                                        var tmp = msg["Time Series (1min)"];
                                        var current_price = null;
                                        for (var date in tmp) {
                                            if (null == current_price) {
                                                current_price = Math.round((tmp[date]["4. close"] * 100) / 100);
                                            }
                                        }

                                        if (debug) {
                                            console.log(share.symbol + ' : ' + current_price);
                                        }
                                        
                                        share.last_price = current_price;

                                        if (null == current_price) {
                                            $().toastmessage('showWarningToast', share.symbol + " price is null");
                                        } else {
                                            $("tr[data-id_share='"+share.symbol+"'].active").each(function () {
                                                $(this).find('td[data-current_unit_price]').data('current_unit_price', current_price);
                                                $(this).find('td[data-current_unit_price] span.current_unit_price').html(current_price);

                                                var buying_price = parseFloat($(this).find('[data-buying_unit_price]').data('buying_unit_price'));
                                                var quantity = parseInt($(this).find('[data-quantity]').data('quantity'));
                                                var last_fee_fixed = parseFloat($(this).data('last_fee_fixed'));
                                                var last_fee_percent = parseFloat($(this).data('last_fee_percent'));
                                                var virtual_gain = ((current_price - buying_price) * quantity) - last_fee_fixed - (last_fee_percent * quantity * buying_price);
                                                var virtual_gain_percent = virtual_gain / (buying_price * quantity) * 100;

                                                var capitalGain = parseFloat($(this).find('[data-totalGain]').data('totalgain'));
                                                var virtual_gain_loose_gain = 'gain';
                                                if (virtual_gain<0) {
                                                    virtual_gain_loose_gain='loose';
                                                }
                                                $(this).find('td[data-virtual_gain_price] span.virtual_gain_price').html(Math.round((virtual_gain * 100) / 100));
                                                $(this).find('td[data-virtual_gain_price]').data('virtual_gain_price', Math.round((virtual_gain * 100) / 100));
                                                $(this).find('td[data-virtual_gain_price]').removeClass('gain loose');
                                                $(this).find('td[data-virtual_gain_price]').addClass(virtual_gain_loose_gain);

                                                $(this).find('td[data-virtual_gain_percent] span.virtual_gain_percent').html(Math.round((virtual_gain_percent * 100) / 100));
                                                $(this).find('td[data-virtual_gain_percent]').data('virtual_gain_percent', Math.round((virtual_gain_percent * 100) / 100));
                                                $(this).find('td[data-virtual_gain_percent]').removeClass('gain loose');
                                                $(this).find('td[data-virtual_gain_percent]').addClass(virtual_gain_loose_gain);

                                                var gain = virtual_gain + capitalGain;
                                                var gain_percent = gain / (buying_price * quantity) * 100;
                                                var gain_loose_gain = 'gain';
                                                if (gain<0) {
                                                    gain_loose_gain='loose';
                                                }
                                                $(this).find('td[data-gain_price] span.gain_price').html(Math.round((gain * 100) / 100));
                                                $(this).find('td[data-gain_price]').data('gain_price', Math.round((gain * 100) / 100));
                                                $(this).find('td[data-gain_price]').removeClass('gain loose');
                                                $(this).find('td[data-gain_price]').addClass(gain_loose_gain);

                                                $(this).find('td[data-gain_percent] span.gain_percent').html(Math.round((gain_percent * 100) / 100));
                                                $(this).find('td[data-gain_percent]').data('gain_percent', Math.round((gain_percent * 100) / 100));
                                                $(this).find('td[data-gain_percent]').removeClass('gain loose');
                                                $(this).find('td[data-gain_percent]').addClass(gain_loose_gain);

                                                reloadPortfolioTotal($(this).parents('table'));

                                             });
                                         }

                                         share_count--;

                                         if (0==share_count)  {
                                             $().toastmessage('showSuccessToast', "Prices updated");
                                         }


                                    })
                                    .fail(function (msg) {
                                        $().toastmessage('showErrorToast', "Error : "+msg);
                                        console.log(msg);
                                    })
                                    .always(function (msg) {
                                        //console.log(msg);
                                        //alert( "complete");
                                    });
                        }
                    });
                }
                


                reloadShare();
                window.setInterval(function(){
                    reloadShare();
                }, 30000);


            });

        </script>


    </head>
    <body>
        <h1>Bonjour <?php echo $templateVar['user']->name; ?></h1>
        <div class="tabs">
            <ul>
                <li><a href="#tab-shares">Shares</a></li>
                <li><a href="#tab-historic">Historic</a></li>
            </ul>

            <div id="tab-shares" class='tabs'>
                <?php
                
                // Order shares by name
                $share_by_name = [];
                foreach($templateVar['user']->shares as $user_share) {
                    $share_by_name[$user_share->share->name] = $user_share;
                }
                ksort($share_by_name);
                
                ?>
                <ul>
                    <?php 
                    foreach($share_by_name as $name => $user_share) {
                    ?>
                    <li><a href="#tab-share-<?php echo $user_share->share->id;?>"><?php echo $name.($user_share->isActive()?' *':'');?></a></li>
                    <?php 
                    }
                    ?>
                </ul>

                <?php 
                foreach($share_by_name as $name => $user_share) {
                ?>
                <div id="tab-share-<?php echo $user_share->share->id;?>" class="share <?php echo $name.($user_share->isActive()?'active':'inactive');?>" >
                    <?php
                    include __DIR__.'/share.inc.html';
                    ?>
                </div>
                <?php 
                }
                ?>
            </div>
            <div id="tab-historic">
                <?php
                include __DIR__.'/historic.inc.html';
                ?>
            </div>
        </div>
        
        <pre>
            @TODO : Shares -> Get number of year for action
            @TODO : Shares -> Get % of dividend per share
            @TODO : Shares -> Add color
            @TODO : Hsitoric -> Add color
            @TODO : Performances -> Portfolio -> Set cash value
            @TODO : Performances -> Portfolio -> Set total
            @TODO : Performances -> Portfolio -> Active -> Set a benchmark value
            @TODO : Performances -> Portfolio -> Set cash history value
            @TODO : Performances -> Portfolio -> Not Active -> Set quantity, unit_price mine and all CAC40, history 
            @TODO : Performances -> Portfolio -> Active -> Set quantity, unit_price mine and all CAC40, history 
            @TODO : Performances -> Portfolio -> Set graph with benchmark
            @TODO : Order and align table
            @TODO : Rebuild webservice management 
            @TODO : Replace last fee by fee
            @TODO : Swap to https://fr.tradingview.com/rest-api-spec/
        </pre>

        @Monnaie : Etherum / Bitcoin /Ripple
        @Information Ocfx / Coin checkup
        @Plateforme Kirachan / Bitstamp
    </body>
</html>
